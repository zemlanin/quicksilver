containers:
  clj:
    environ:
      HOME: /work/target
      LEIN_ROOT: 1
    setup:
    - !Alpine v3.4
    - !Sh |
        echo @community http://dl-3.alpinelinux.org/alpine/v3.4/community >> /etc/apk/repositories
        apk update
    - !Install
      - ca-certificates
      - wget
      - bash
      - openjdk8-jre@community
    - !EnsureDir /usr/share/java
    - !Sh |
        update-ca-certificates -f
        wget -O /usr/share/java/leiningen-2.5.3-standalone.jar \
          https://github.com/technomancy/leiningen/releases/download/2.5.3/leiningen-2.5.3-standalone.zip
        wget -O /usr/bin/lein \
          https://raw.githubusercontent.com/technomancy/leiningen/2.5.3/bin/lein-pkg
        chmod +x /usr/bin/lein
    - !Sh
      # Because Java doesn't like HOME environment variable and use value from /etc/passwd instead
      sed -i '/^root/{s@/root@/work/target@;}' /etc/passwd

commands:
  build: !Command
    container: clj
    run: |
      /usr/bin/lein uberjar
      mkdir -p artifacts/
      cp /work/target/uberjar/quicksilver-0.1.0-SNAPSHOT-standalone.jar /work/artifacts/qs.jar
